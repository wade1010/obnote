用户态协议栈是指把网络协议栈accept()、listen()等原本在操作系统中的接口，与应用程序放在一起，把网络协议的解析放做进程中的一部分。用户态协议栈的主要作用，是网络数据从网卡到应用程序拷贝过程中的系统调用次数，从而减少CPU上下文切换的次数，达到提高性能的目的。

有了用户态协议栈，对于网卡的想象空间也会增大，网卡的可操作性会更强。比如，可以通过控制网卡，将PC机做成交换机或路由器，可以过滤数据。另外，用户态协议栈可以用在网关上，因为当连接数增多，网关会成为性能的瓶颈，使用用户态协议栈可以提高网关的性能。

## 通信流程

![](https://gitee.com/hxc8/images6/raw/master/img/202407190007721.jpg)

### 网卡

网卡不属于七层模型中的任何一层，是在物理层和数据链路层之间，其作用是将网络中的光电信号与计算机能识别的数字信号进行相互转换。

### 协议栈

是操作系统内核中，对网卡数据进行解析的部分，通过结构体sk_buff将网卡中的数据拷贝到协议栈（位于内核中）中。

数据拷贝过程

每次数据从网卡到达应用程序，需经历两次拷贝过程，一次是上面提及的从网卡拷贝到协议栈中，另一次是从内核协议栈拷贝到应用程序的用户空间中。

这里介绍一下零拷贝技术。可以通过mmap映射的方式，将网卡中的数据直接映射到内存中，由于行走程序可以直接访问内存，再加上DMA支持。由于映射过程使用DMA自己操作，不需要CPU干预，所以没有显式的拷贝操作，叫做零拷贝技术。

这里简单介绍一下，如何从网卡中取到一帧完整的网络数据。有三个方法，一是利用原生的socket如raw socket，二是利用开源框架如netmap，三是利用商业框架如dpdk。

这里扩展一点，驱动程序是运行在操作系统的内核中，而不是运行在对应的硬件上，包括nic子系统也是运行在内核上使网卡正常工作的。

另外，零拷贝技术还可以用在持久化操作中，例如日志落盘，先写在内存中的映射区，而后由映射区同步到磁盘中，优点是比直接操作文件快，缺点是无法保证写到磁盘中的数据是全部数据，因为在映射区中还未同步的数据有可能被覆盖或丢失。