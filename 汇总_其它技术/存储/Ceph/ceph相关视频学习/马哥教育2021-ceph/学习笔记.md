Agenda

·系统组件介绍

·存储工作机制

·系统部署

·存储池(pool)与归置组(PG)

·块存储(rbd)

·文件系统(cephfs)

·对象存储(radosgw)

·自定义CRUSHMAP

![](https://gitee.com/hxc8/images6/raw/master/img/202407182356994.jpg)

ceph存储最底层叫RADOS存储服务，而RADOS内部是使用很多主机组织起来成为一个存储集群。

这个存储集群通常要运行一些服务，或者称守护进程，以确保每一个主机上所提供的的存储空间，存储空间来自于本地。

那主机本地存储空间是以什么形式供给的呢？也就是说，当你存一个数据的时候，要发给一个存储集群，这个储存集群最终要扔给某个主机来存，这个主机到底应该把对方扔过来的一个对象怎么存?

对于ceph而言，它会把每一个大的文件都切割为一个固定大小的对象来进行存储， 比如默认切割为4M，这个4M对象最终还是要被每个节点存的， 这个节点吧它存那儿？

对于一个节点来说，它还是把这个4M文件存在自己的文件系统上，所以每一个节点本机它应该会有个磁盘，这个磁盘在本机上怎么管理？已经创建好分区格式化做完文件系统，支持xfs，ext4不让使用，那就使用xfs好了，这个每一个对象其实还要存在文件系统上，只不过是本地文件系统。

你会发现，这个对象本身它有数据和元数据，到最后又被分成元数据和数据放到节点上去了， 这样性能肯定受影响，所以后来ceph版本换了个方式，它直接使用磁盘，不让你格式化挂载，ceph自己直接管理这个磁盘，当你需要存储数据到这个节点时，这个节点要直接把它扔到这个磁盘上就行，而这个磁盘内部，有自己的裸设备管理逻辑，而不是文件系统级的管理逻辑。

ceph的两种存储引擎，FilesSore和BlueStore

![](https://gitee.com/hxc8/images6/raw/master/img/202407182356508.jpg)

MON 用于提供维护集群元数据，而非文件元数据

内部使用PAXOS协议实现数据冗余，强一致

想要监控整个RADOS集群，就得向整个MON去做很多查询才能获得这个数据，实时查询通常代价高昂，因此MON不太试用频繁的周期性采集数据这种监控操作，但是监控又是必须的，所以后来新版本的ceph引入一个mgr组件，这个组件专门维护所谓的查询类操作，它把很多的查询操作按照自己内部空闲的方式先缓存下来。

把对象的名字做hash计算，映射到hash环上，这个hash环上遍布有PG,通过顺时针找到离它最近的那个PG

数据先写到主OSD上，然后由主OSD同步给副本OSD

ceph存储池 支持 副本冗余和纠删码池

![](https://gitee.com/hxc8/images6/raw/master/img/202407182356632.jpg)

假设一个文件有16M，不管通过任何客户端访问RADOS，默认切分是4M，这个对象都会被切分成4个4M Object，这每个对象提交给RADOS后，找到pool,pool内部把它映射给PG，PG再把它映射给OSD，

存在OSD上肯定要先交给OSD所在的主机，主机怎么访问磁盘空间？一般通过内核访问，通过内核访问无非两种接口，第一，把这个磁盘格式化做个文件系统，然后把对象放到文件系统上，你会发现这个对象变成了文件系统的文件，发现又还原成文件了，因此这个OSD需要去维护这个对象的数据和元数据，元数据放在文件系统的元数据取，但是文件系统元数据取只能放属主数组权限时间戳等，但是ceph对象却又很多其它非标准的文件系统键值的元数据，这些元数据存哪里呢？因为用户可以自定义元数据，所以为了存放这些额外的元数据，这个时候每个OSD要做成一个xfs文件系统，在这个xfs文件系统内部，还有一个单独的被ceph自己维护的数据库，这个数据库比如叫做levelDB。所以当我们把一个对象以文件的形式存储在xfs系统上的时候，那对象数据就存在文件系统上，那对象的标识符就当做元数据之类的被存在我们文件的元数据里面，对象也有自己的元数据，存放在levelDB里面。这种存储逻辑就叫**FileStore**,这种存储有一个缺陷，明明已经换成对象了，却不得不退化回文件接口，这个性能有点差。

新时代被组织为**BlueStore**,它是这么做的，OSD就是个块设备，没有被格式成文件系统，就是个裸设备，OSD的守护进程怎么用OSD这个块设备的呢？直接把这个存储空间也做成内部包含一个levelDB专门放元数据，对象数据本身是由ceph OSD自己管理的，不被组织成文件了，直接以数据的方式放过来的。

早期的时候使用的是levelDB,后来Facebook对levelDB做了改进，升级成rocksDB， 这里rocksDB下面是裸设备，不支持，因此rocksDB下面，就这以下块，底下还得有个文件系统，为此ceph专门给它开发了个文件系统，叫BlueFS。因此对象的本身存在存储空间里面，对象元数据放在rocksDB上，更有意思的是rocksDB是个存储，这个存储自己为了实现它的冗余性，就像redis一样，redis为了确保它的持久性，它要使用snapshot或者aof来管理它的数据持久性，那rocksDB也要通过所谓的像WAL这种方式来管理它的写日志，这么一来，BuleStore存的数据分了三类。第一数据，第二元数据，第三就是元数据的元数据（元数据放在rocksDB当中，rocksDB为了快速存这个元数据，他自己还需要再维护一个存储空间）

bluestore分别支持三种不同的存储设备，比如把rocksdb和buluefs存在一个固态硬盘上，把数据放在机械盘上，可以分开放，而且bluefs(就是rocksdb的元数据的那个数据)持久存放可以放在一个nvme的固态硬盘上，可以分三级存放，因为它们各自读写要求不一样。

![](https://gitee.com/hxc8/images6/raw/master/img/202407182356281.jpg)